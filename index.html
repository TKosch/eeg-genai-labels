<!DOCTYPE html>
<html>
<head>
  <title>AI Image Rating Task</title>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    img {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      margin-bottom: 20px;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #555;
      margin-bottom: 5px;
    }
    #slider, #confidenceSlider {
      width: 100%;
    }
    #nextButton:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #progress {
      font-size: 0.9em;
      color: #333;
      margin-bottom: 10px;
      text-align: right;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="ratingInterface">
      <div id="progress">Image 1 of X</div>
      <img id="imageToRate" src="" alt="Image to rate">

      <p><strong>This image was created with the help of generative AI.</strong></p>

      <div class="slider-labels">
        <span>Strongly Disagree</span>
        <span>Strongly Agree</span>
      </div>
      <input type="range" id="slider" min="1" max="100" value="50">

      <br><br>
      <label><strong>The image is AI-generated:</strong></label><br>
      <input type="radio" id="aiYes" name="aiGuess" value="Yes">
      <label for="aiYes">Yes</label><br>
      <input type="radio" id="aiNo" name="aiGuess" value="No">
      <label for="aiNo">No</label>

      <br><br>
      <label><strong>I am confident in my response.</strong></label>
      <div class="slider-labels">
        <span>Strongly Disagree</span>
        <span>Strongly Agree</span>
      </div>
      <input type="range" id="confidenceSlider" min="1" max="100" value="50">

      <br><br>
      <button id="nextButton" onclick="submitResponse()" disabled>Next Image</button>
    </div>

    <div id="confirmationPage" class="hidden">
      <h2>Thank you!</h2>
      <p>You have rated all images. Please click the arrow below to continue.</p>
    </div>
  </div>

  <script>
    const imagePaths = [
      "stimuli/ai_generated/man_filtered/asian/1.jpg",
      "stimuli/ai_generated/man_filtered/black/1.jpg",
      "stimuli/ai_generated/man_filtered/latino/1.jpg",
      "stimuli/ai_generated/man_filtered/white/1.jpg"
      // Add additional images here
    ];

    const shuffledImages = imagePaths.sort(() => 0.5 - Math.random());
    const totalImages = shuffledImages.length;
    const defaultSliderValue = 50;
    let currentIndex = 0;
    let startTime = null;

    const participantId = getProlificID();
    const responseData = {
      participant_id: participantId,
      responses: []
    };

    function getProlificID() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("PROLIFIC_PID") || "unknown";
    }

    function updateProgress() {
      document.getElementById("progress").innerText =
        `Image ${currentIndex + 1} of ${totalImages}`;
      document.getElementById("nextButton").textContent =
        (currentIndex === totalImages - 1) ? "Finish" : "Next Image";
    }

    function checkInputCompletion() {
      const ratingMoved = document.getElementById("slider").value != defaultSliderValue;
      const confidenceMoved = document.getElementById("confidenceSlider").value != defaultSliderValue;
      const radioSelected = !!document.querySelector('input[name="aiGuess"]:checked');
      document.getElementById("nextButton").disabled = !(ratingMoved && confidenceMoved && radioSelected);
    }

    function loadNextImage() {
      if (currentIndex >= totalImages) {
        showConfirmationPage();
        return;
      }

      document.getElementById("imageToRate").src = shuffledImages[currentIndex];
      document.getElementById("slider").value = defaultSliderValue;
      document.getElementById("confidenceSlider").value = defaultSliderValue;
      document.querySelectorAll('input[name="aiGuess"]').forEach(el => el.checked = false);
      document.getElementById("nextButton").disabled = true;

      startTime = Date.now();
      updateProgress();
    }

    function showConfirmationPage() {
      document.getElementById("ratingInterface").classList.add("hidden");
      document.getElementById("confirmationPage").classList.remove("hidden");

      // Send results to Qualtrics
      window.parent.postMessage({
        type: "ai_image_rating_data",
        payload: responseData
      }, "*");
    }

    function submitResponse() {
      const endTime = Date.now();
      const timeTaken = ((endTime - startTime) / 1000).toFixed(2);
      const sliderValue = document.getElementById("slider").value;
      const confidenceValue = document.getElementById("confidenceSlider").value;
      const aiGuess = document.querySelector('input[name="aiGuess"]:checked')?.value;
      const imageShown = shuffledImages[currentIndex];
      const groundTruth = imageShown.includes("ai_generated") ? "Yes" : "No";
      const isCorrect = aiGuess === groundTruth;

      responseData.responses.push({
        image: imageShown,
        rating: sliderValue,
        confidence: confidenceValue,
        aiGuess: aiGuess,
        correct: isCorrect,
        time: parseFloat(timeTaken)
      });

      currentIndex++;
      loadNextImage();
    }

    window.onload = function () {
      loadNextImage();
      document.getElementById("slider").addEventListener("input", checkInputCompletion);
      document.getElementById("confidenceSlider").addEventListener("input", checkInputCompletion);
      document.querySelectorAll('input[name="aiGuess"]').forEach(el =>
        el.addEventListener("change", checkInputCompletion)
      );
    };
  </script>
</body>
</html>
