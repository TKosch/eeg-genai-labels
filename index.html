<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AI Image Rating Task</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 700px; margin: auto; }
    img { width: 100%; max-height: 320px; object-fit: contain; margin-bottom: 20px; border-radius: 6px; }
    .slider-labels { display: flex; justify-content: space-between; font-size: 0.9em; color: #555; margin-bottom: 6px; }
    #slider, #confidenceSlider { width: 100%; }
    #nextButton { padding: 10px 16px; font-size: 1rem; border: none; border-radius: 6px; background: #2d6cdf; color: #fff; }
    #nextButton:disabled { background-color: #ccc; cursor: not-allowed; }
    #progress { font-size: 0.9em; color: #333; margin-bottom: 10px; text-align: right; }
    .hidden { display: none; }
    .note { font-size: 0.9em; color: #555; margin-bottom: 8px; }
  </style>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZ2S2cdztJc7Xh9PKBHHtSJP5Z-ZitRHY",
      authDomain: "ai-labels-4a313.firebaseapp.com",
      projectId: "ai-labels-4a313",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.__FIREBASE__ = { db, auth, onAuthStateChanged, signInAnonymously };
  </script>
</head>
<body>
  <div class="container">
    
    <div id="ratingInterface">
      <div id="progress">Loading…</div>
      <img id="imageToRate" src="" alt="Image to rate" />

      <p><strong>This image was created with the help of generative AI.</strong></p>

      <div class="slider-section">
        <div class="slider-labels">
          <span>Strongly Disagree</span>
          <span>Strongly Agree</span>
        </div>
        <input type="range" id="slider" min="1" max="100" value="50" />
      </div>

      <br />
      <label for="confidenceSlider"><strong>I am confident in my response.</strong></label>
      <div class="slider-labels">
        <span>Strongly Disagree</span>
        <span>Strongly Agree</span>
      </div>
      <input type="range" id="confidenceSlider" min="1" max="100" value="50" />

      <br /><br />
      <button id="nextButton" disabled>Next Image</button>
    </div>

    <div id="confirmationPage" class="hidden">
      <h2>Thank you!</h2>
      <p>You have rated all available images. Please click the arrow below to continue.</p>
    </div>
  </div>
  <script>
    // ===================== PARAMETERS =====================
    const TARGET_RATINGS = 30;
    // ===================== IMAGES WITH STARTING COUNTS =====================
    const imagesWithCounts = [
      
      { path: "stimuli/ai_generated/man_filtered/latino/men_0424.jpg", count: 28 },
      { path: "stimuli/ai_generated/man_filtered/latino/men_1285.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/asian/woman_0554.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/asian/woman_1348.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0168.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0489.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_1370.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0197.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0222.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0811.jpg", count: 28 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0986.jpg", count: 28 },
      { path: "stimuli/ai_generated/man_filtered/latino/men_1222.jpg", count: 27 },
      { path: "stimuli/ai_generated/man_filtered/white/man_0179.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/asian/woman_1239.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0030.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0096.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_0450.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_1204.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0007.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0983.jpg", count: 27 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_1090.jpg", count: 27 },
      { path: "stimuli/ai_generated/man_filtered/latino/men_0367.jpg", count: 26 },
      { path: "stimuli/ai_generated/man_filtered/latino/men_1228.jpg", count: 26 },
      { path: "stimuli/ai_generated/man_filtered/white/man_0169.jpg", count: 26 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0018.jpg", count: 26 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0466.jpg", count: 26 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_0081.jpg", count: 26 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_0504.jpg", count: 26 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_1317.jpg", count: 26 },
      { path: "stimuli/ai_generated/woman_filtered/asian/woman_0261.jpg", count: 25 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0488.jpg", count: 25 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_1232.jpg", count: 25 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0019.jpg", count: 25 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_0223.jpg", count: 25 },
      { path: "stimuli/ai_generated/woman_filtered/white/woman_1083.jpg", count: 25 },
      { path: "stimuli/ai_generated/man_filtered/white/men_0233.jpg", count: 24 },
      { path: "stimuli/ai_generated/woman_filtered/asian/woman_0596.jpg", count: 24 },
      { path: "stimuli/ai_generated/woman_filtered/latino/woman_0259.jpg", count: 24 },
      { path: "stimuli/ai_generated/woman_filtered/black/woman_0502.jpg", count: 20 },

  ]
  </script>
  <script>

    let shuffledImages = [];
    let currentIndex = -1;
    let currentImage = null;
  
    const elImg = document.getElementById("imageToRate");
    const elSlider = document.getElementById("slider");
    const elConf = document.getElementById("confidenceSlider");
    const elNext = document.getElementById("nextButton");
    const elProgress = document.getElementById("progress");
    const elRating = document.getElementById("ratingInterface");
    const elConfirm = document.getElementById("confirmationPage");
  
    // Shuffle helper
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  
    // Preload images
    async function preload(paths) {
      for (const item of paths) {
        await new Promise((resolve, reject) => {
          const img = new Image();
          img.src = item.path;  // ✅ use .path
          img.onload = () => { console.log("Preloaded:", item.path); resolve(); };
          img.onerror = () => { console.error("Failed to load:", item.path); reject(); };
        });
      }
    }
  
    // Load the next image
    function loadNextImage() {
      currentIndex++;
      if (currentIndex >= shuffledImages.length) {
      elRating.classList.add("hidden");
      elConfirm.classList.remove("hidden");

      // ✅ Notify Qualtrics we are done
      window.parent.postMessage({
        type: "ai_image_rating_data",
        payload: {
          finished: true,
          participant_id: "done"
        }
      }, "*");

  return;
}

      currentImage = shuffledImages[currentIndex];
      console.log("Loading image:", currentImage.path); // ✅ debug path
      elImg.src = currentImage.path;  // ✅ assign path
      elProgress.textContent = `Image ${currentIndex + 1} of ${shuffledImages.length}`;
      elNext.disabled = true; // disable until slider moved
    }
  
    // Event: enable "Next" when sliders moved
    elSlider.addEventListener("input", () => elNext.disabled = false);
    elConf.addEventListener("input", () => elNext.disabled = false);
  
    // Event: on "Next"
    elNext.addEventListener("click", () => {
      if (currentImage) {
        window.parent.postMessage({
          type: "ai_image_rating_data",
          payload: {
            image: currentImage.path,
            rating: elSlider.value,
            confidence: elConf.value
          }
        }, "*");
      }
      loadNextImage();
    });

  
    // Init
  (async () => {
  // Shuffle all images and select 40 random ones
    shuffledImages = shuffle([...imagesWithCounts]).slice(0, 40);

  // Show the first one immediately
    loadNextImage();

      // Start preloading the rest quietly
      for (let i = 1; i < shuffledImages.length; i++) {
        const img = new Image();
        img.src = shuffledImages[i].path;
      }
  })();


  </script>
  
 